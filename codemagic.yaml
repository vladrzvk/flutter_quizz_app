workflows:
  ios-testflight:
    name: iOS TestFlight
    max_build_duration: 120
    instance_type: mac_mini_m2
    working_directory: frontend
    integrations:
      app_store_connect: last_key_intgration_created

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.petits.quizz.de.geo


      vars:
        TEAM_ID: 3UZ57ACSD9
        BUNDLE_ID: com.petits.quizz.de.geo

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'develop'
          include: true
          source: true
      cancel_previous_builds: true

    scripts:
      - name: Set up code signing
        script: |
          keychain initialize
          keychain add-certificates
          xcode-project use-profiles
          echo "=== Profiles disponibles ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || true

      - name: Get Flutter packages
        script: |
          flutter packages pub get

      - name: Flutter clean
        script: |
          flutter clean

      - name: Generate iOS platform files
        script: |
          # Cette commande génère les fichiers iOS nécessaires incluant le Podfile
          flutter create --platform ios . --org com.petits.quizz.de.geo
          
          # Ou utiliser cette alternative qui génère aussi les fichiers
          # flutter build ios --config-only  --no-codesign

      - name: Configure iOS deployment target
        script: |
          cd ios
          
          # Vérifier que le Podfile existe maintenant
          if [ -f "Podfile" ]; then
            echo "Podfile trouvé, mise à jour de la version iOS..."
          
            # Forcer iOS 13.0
            sed -i '' "s/platform :ios, .*/platform :ios, '13.0'/" Podfile
          
            # Si la ligne n'existe pas, l'ajouter
            if ! grep -q "platform :ios" Podfile; then
              sed -i '' '1i\
              platform :ios, '\''13.0'\''
              ' Podfile
            fi
          
            # Vérifier le contenu
            echo "=== Contenu du Podfile ==="
            cat Podfile
          else
            echo "Erreur: Podfile non trouvé après génération"
            exit 1
          fi
          
          # Mettre à jour le deployment target dans le projet Xcode
          sed -i '' "s/IPHONEOS_DEPLOYMENT_TARGET = .*/IPHONEOS_DEPLOYMENT_TARGET = 13.0;/g" Runner.xcodeproj/project.pbxproj

      - name: Install CocoaPods dependencies
        script: |
          cd ios
          rm -rf Pods Podfile.lock
          pod install --repo-update

      - name: Build IPA
        script: |
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          
          # Créer le fichier ExportOptions.plist
          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>3UZ57ACSD9</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
              <key>com.petits.quizz.de.geo</key>
              <string>Second_profil</string>  <!-- Nom de ton profil (pas UUID) -->
              </dict>
          </dict>
          </plist>
          EOF
          
          # Build l'IPA
          flutter build ipa \
            --release \
            --build-number=$BUILD_NUMBER \
            --export-options-plist=ios/ExportOptions.plist

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log

    publishing:
      email:
        recipients:
          - vlad.razyvika@outlook.fr
        notify:
          success: true
          failure: true

      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - Internal Testers
        submit_to_app_store: false

  #
#    ios-production:
#      name: iOS Production
#      max_build_duration: 90
#      instance_type: mac_mini_m2
#      working_directory: frontend
#      integrations:
#        app_store_connect: last_key_intgration_created
#
#      environment:
#        flutter: stable
#        xcode: latest
#        cocoapods: default
#
#        ios_signing:
#          distribution_type: app_store
#          bundle_identifier: com.petits.quizz.de.geo
#
#      triggering:
#        events:
#          - tag
#        tag_patterns:
#          - pattern: 'v*'
#            include: true
#        cancel_previous_builds: true
#
#      scripts:
#        - name: Set up code signing
#          script: |
#            keychain initialize
#            keychain add-certificates
#            xcode-project use-profiles
#
#        - name: Get Flutter packages
#          script: |
#            flutter packages pub get
#
#        - name: Flutter analyze
#          script: |
#            flutter analyze
#
#        - name: Run tests
#          script: |
#            flutter test
#          ignore_failure: false
#
#        - name: Install pods
#          script: |
#            find . -name "Podfile" -execdir pod install \;
#
#        - name: Build IPA
#          script: |
#            BUILD_NUMBER=$(($(git rev-list --count HEAD) + 1))
#            flutter build ipa --release --build-number=$BUILD_NUMBER
#
#      artifacts:
#        - build/ios/ipa/*.ipa
#
#      publishing:
#        email:
#          recipients:
#            - vlad.razyvika@outlook.fr
#          notify:
#            success: true
#            failure: true
#
#        app_store_connect:
#          auth: integration
#          submit_to_testflight: true
#          beta_groups:
#            - Internal Testers
#          submit_to_app_store: false

  #      app_store_connect:
  #        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
  #        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
  #        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
  #        submit_to_testflight: true
  #        submit_to_app_store: false  # Mettre true pour production

  # android prod inc


  #        android-production:
  #          name: Android Production
  #          max_build_duration: 60
  #          instance_type: linux_x2
  #          working_directory: frontend
  #
  #          environment:
  #            flutter: stable
  #            java: 17
  #
  #            groups:
  #              - google_play_credentials
  #
  #            vars:
  #              PACKAGE_NAME: "com.petits.quizz.de.geo"
  #
  #          triggering:
  #            events:
  #              - push
  #              - tag
  #            branch_patterns:
  #              - pattern: 'main'
  #                include: true
  #                source: true
  #            tag_patterns:
  #              - pattern: 'v*'
  #                include: true
  #            cancel_previous_builds: true
  #
  #          scripts:
  #            - name: Set up local properties
  #              script: |
  #                echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"
  #
  #            - name: Get Flutter packages
  #              script: |
  #                flutter packages pub get
  #
  #            - name: Flutter analyze
  #              script: |
  #                flutter analyze
  #
  #            - name: Run tests
  #              script: |
  #                flutter test
  #              ignore_failure: false
  #
  #            - name: Build APK
  #              script: |
  #                BUILD_NUMBER=$(($(git rev-list --count HEAD) + 1))
  #                flutter build apk --release --build-number=$BUILD_NUMBER
  #
  #            - name: Build App Bundle
  #              script: |
  #                BUILD_NUMBER=$(($(git rev-list --count HEAD) + 1))
  #                flutter build appbundle --release --build-number=$BUILD_NUMBER
  #
  #          artifacts:
  #            - build/app/outputs/**/*.apk
  #            - build/app/outputs/**/*.aab
  #
  #          publishing:
  #            email:
  #              recipients:
  #                - votre-email@example.com
  #              notify:
  #                success: true
  #                failure: true
  #
  #            google_play:
  #              credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
  #              track: internal
  #              submit_as_draft: true
services:
  # ============================================
  # DATABASES (4 PostgreSQL instances)
  # ============================================

  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth_service
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-auth_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
      - ./docker/init-scripts/01-auth-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgres-quiz:
    image: postgres:16-alpine
    container_name: postgres-quiz
    environment:
      POSTGRES_DB: quiz_db
      POSTGRES_USER: quiz_user
      POSTGRES_PASSWORD: ${QUIZ_DB_PASSWORD:-quiz_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5436:5432"
    volumes:
      - postgres-quiz-data:/var/lib/postgresql/data
      - ./docker/init-scripts/05-quiz-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quiz_user -d quiz_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # BACKEND SERVICES (avec mTLS)
  # ============================================

  quiz-core-service:
    build:
      context: .
      dockerfile: docker/backend_chef.Dockerfile
    container_name: quiz-core-service
    environment:
      # Service config
      PORT: 8080
      HOST: 0.0.0.0
      RUST_LOG: debug  # Augment√© pour voir logs mTLS

      # Database
      DATABASE_URL: postgres://quiz_user:${QUIZ_DB_PASSWORD:-quiz_secret_dev}@postgres-quiz:5432/quiz_db

      # Services URLs (pas utilis√© par quiz-core, mais pour coh√©rence)
      AUTH_SERVICE_URL: http://auth-service:3001
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
      ADS_SERVICE_URL: http://ads-service:3004

      # üîê mTLS Configuration
      MTLS_ENABLED: "true"
      MTLS_CERT_PATH: "/etc/tls/tls.crt"
      MTLS_KEY_PATH: "/etc/tls/tls.key"
      MTLS_CA_PATH: "/etc/tls/ca.crt"
      MTLS_VERIFY_CLIENT: "true"
      MTLS_STRICT_MODE: "true"
      MTLS_CHECK_REVOCATION: "false"  # D√©sactiv√© pour dev
      MTLS_ALLOWED_CNS: "gateway"     # Seul gateway peut se connecter

    volumes:
      # üîê Monter certificats mTLS (depuis scripts/certs/generated/)
      - ./scripts/certs/generated/quiz-service.crt:/etc/tls/tls.crt:ro
      - ./scripts/certs/generated/quiz-service.key:/etc/tls/tls.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/tls/ca.crt:ro

    expose:
      - 8080  # HTTPS/mTLS uniquement
    # Ne PAS exposer sur host (seulement via gateway)

    depends_on:
      postgres-quiz:
        condition: service_healthy

    networks:
      - backend-network

    healthcheck:
      # ‚ö†Ô∏è Health check doit utiliser HTTPS avec certificat client
      test: ["CMD", "curl", "--insecure", "--cert", "/etc/tls/tls.crt", "--key", "/etc/tls/tls.key", "--cacert", "/etc/tls/ca.crt", "https://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: backend/api_gateway/Dockerfile
    container_name: api-gateway
    environment:
      # Service config
      PORT: 8000
      HOST: 0.0.0.0
      RUST_LOG: debug  # Augment√© pour voir logs mTLS

      # üîê Service URLs avec HTTPS (mTLS)
      AUTH_SERVICE_URL: http://auth-service:3001  # Pas encore mTLS
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002  # Pas encore mTLS
      ADS_SERVICE_URL: http://ads-service:3004  # Pas encore mTLS
      QUIZ_CORE_SERVICE_URL: https://quiz-core-service:8080  # ‚ö†Ô∏è HTTPS avec mTLS

      # Rate limiting
      RATE_LIMIT_REQUESTS_PER_MINUTE: 100

      # üîê mTLS Configuration (Gateway = client + serveur)
      MTLS_ENABLED: "true"
      MTLS_CERT_PATH: "/etc/tls/tls.crt"
      MTLS_KEY_PATH: "/etc/tls/tls.key"
      MTLS_CA_PATH: "/etc/tls/ca.crt"
      MTLS_VERIFY_CLIENT: "false"  # Gateway n'exige pas certificat client depuis frontend
      MTLS_STRICT_MODE: "true"
      MTLS_CHECK_REVOCATION: "false"
      MTLS_ALLOWED_CNS: "quiz-service,auth-service"  # Services que Gateway peut appeler

    volumes:
      # üîê Monter certificats Gateway
      - ./scripts/certs/generated/gateway.crt:/etc/tls/tls.crt:ro
      - ./scripts/certs/generated/gateway.key:/etc/tls/tls.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/tls/ca.crt:ro

    ports:
      - "8000:8000"  # Expos√© sur host (HTTP standard depuis frontend)

    depends_on:
      quiz-core-service:
        condition: service_healthy

    networks:
      - backend-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  backend-network:
    driver: bridge
    name: quiz-backend-network

# ============================================
# VOLUMES
# ============================================

volumes:
  postgres-auth-data:
    name: postgres-auth-data

  postgres-quiz-data:
    name: quiz-postgres-quiz-data
services:
  # ============================================
  # DATABASES (4 PostgreSQL instances)
  # ============================================

  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth_service
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-auth_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
      - ./docker/init-scripts/01-auth-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  #  postgres-subscription:
  #    image: postgres:16-alpine
  #    container_name: postgres-subscription_service
  #    environment:
  #      POSTGRES_DB: subscription_db
  #      POSTGRES_USER: subscription_user
  #      POSTGRES_PASSWORD: ${SUBSCRIPTION_DB_PASSWORD:-subscription_secret_dev}
  #      POSTGRES_INITDB_ARGS: "-E UTF8"
  #    ports:
  #      - "5433:5432"
  #    volumes:
  #      - postgres-subscription_service-data:/var/lib/postgresql/data
  #      - ./docker/init-scripts/02-subscription-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD-SHELL", "pg_isready -U subscription_user -d subscription_db"]
  #      interval: 10s
  #      timeout: 5s
  #      retries: 5
  #    restart: unless-stopped

  #  postgres-ads:
  #    image: postgres:16-alpine
  #    container_name: postgres-ads_service
  #    environment:
  #      POSTGRES_DB: ads_db
  #      POSTGRES_USER: ads_user
  #      POSTGRES_PASSWORD: ${ADS_DB_PASSWORD:-ads_secret_dev}
  #      POSTGRES_INITDB_ARGS: "-E UTF8"
  #    ports:
  #      - "5435:5432"
  #    volumes:
  #      - postgres-ads_service-data:/var/lib/postgresql/data
  #      - ./docker/init-scripts/04-ads-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD-SHELL", "pg_isready -U ads_user -d ads_db"]
  #      interval: 10s
  #      timeout: 5s
  #      retries: 5
  #    restart: unless-stopped

  postgres-quiz:
    image: postgres:16-alpine
    container_name: postgres-quiz
    environment:
      POSTGRES_DB: quiz_db
      POSTGRES_USER: quiz_user
      POSTGRES_PASSWORD: ${QUIZ_DB_PASSWORD:-quiz_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5436:5432"
    volumes:
      - postgres-quiz-data:/var/lib/postgresql/data
      - ./docker/init-scripts/05-quiz-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quiz_user -d quiz_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # BACKEND SERVICES avec mTLS
  # ============================================

  auth-service:
    build:
      context: .
      dockerfile: backend/auth_service/Dockerfile
      args:
        SERVICE_NAME: auth_service
    container_name: auth_service-service
    environment:
      # Service config
      PORT: 3001
      RUST_LOG: ${AUTH_RUST_LOG:-info}

      # Database
      DATABASE_URL: postgres://auth_user:${AUTH_DB_PASSWORD:-auth_secret_dev}@postgres-auth_service:5432/auth_db

      # mTLS Configuration (SERVEUR uniquement - reçoit des connexions)
      MTLS_ENABLED: "true"
      MTLS_REQUIRE_CLIENT_CERT: "true"
      MTLS_SERVER_CERT: /etc/mtls/certs/server.crt
      MTLS_SERVER_KEY: /etc/mtls/certs/server.key
      MTLS_CLIENT_CA_CERT: /etc/mtls/certs/ca.crt

      # JWT
      JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret_change_in_production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev_refresh_secret_change_in_production}
      JWT_EXPIRATION_HOURS: ${JWT_EXPIRATION_HOURS:-168}
      JWT_REFRESH_EXPIRATION_HOURS: ${JWT_REFRESH_EXPIRATION_HOURS:-720}

      # OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      APPLE_CLIENT_ID: ${APPLE_CLIENT_ID:-}
      APPLE_TEAM_ID: ${APPLE_TEAM_ID:-}

    volumes:
      # Montage certificats mTLS (SERVEUR)
      - ./scripts/certs/generated/auth-service-server.crt:/etc/mtls/certs/server.crt:ro
      - ./scripts/certs/generated/auth-service-server.key:/etc/mtls/certs/server.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/mtls/certs/ca.crt:ro
    ports:
      - "3001:3001"
    depends_on:
      postgres-auth:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  #  subscription-service:
  #    build:
  #      context: .
  #      dockerfile: docker/subscription.Dockerfile
  #      args:
  #        SERVICE_NAME: subscription_service
  #    container_name: subscription_service-service
  #    environment:
  #      PORT: 3002
  #      RUST_LOG: ${SUBSCRIPTION_RUST_LOG:-info}
  #      DATABASE_URL: postgres://subscription_user:${SUBSCRIPTION_DB_PASSWORD:-subscription_secret_dev}@postgres-subscription_service:5432/subscription_db
  #      AUTH_SERVICE_URL: https://auth-service:3001
  #
  #      # Apple IAP
  #      APPLE_SHARED_SECRET: ${APPLE_SHARED_SECRET:-}
  #      APPLE_BUNDLE_ID: ${APPLE_BUNDLE_ID:-}
  #
  #      # Google IAP
  #      GOOGLE_SERVICE_ACCOUNT_JSON: ${GOOGLE_SERVICE_ACCOUNT_JSON:-}
  #
  #    ports:
  #      - "3002:3002"
  #    depends_on:
  #      postgres-subscription:
  #        condition: service_healthy
  #      auth-service:
  #        condition: service_healthy
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
  #      interval: 30s
  #      timeout: 10s
  #      retries: 3
  #      start_period: 40s
  #    restart: unless-stopped

  #  ads-service:
  #    build:
  #      context: .
  #      dockerfile: docker/ads.Dockerfile
  #      args:
  #        SERVICE_NAME: ads_service
  #    container_name: ads_service-service
  #    environment:
  #      PORT: 3004
  #      RUST_LOG: ${ADS_RUST_LOG:-info}
  #      DATABASE_URL: postgres://ads_user:${ADS_DB_PASSWORD:-ads_secret_dev}@postgres-ads_service:5432/ads_db
  #      AUTH_SERVICE_URL: https://auth-service:3001
  #      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
  #
  #      # AdMob
  #      ADMOB_APP_ID: ${ADMOB_APP_ID:-}
  #      ADMOB_PUBLISHER_ID: ${ADMOB_PUBLISHER_ID:-}
  #
  #    ports:
  #      - "3004:3004"
  #    depends_on:
  #      postgres-ads:
  #        condition: service_healthy
  #      auth-service:
  #        condition: service_healthy
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
  #      interval: 30s
  #      timeout: 10s
  #      retries: 3
  #      start_period: 40s
  #    restart: unless-stopped

  quiz-core-service:
    build:
      context: .
      dockerfile: docker/backend_chef.Dockerfile
    container_name: quiz-core-service
    environment:
      # Service config
      PORT: 8080
      RUST_LOG: ${QUIZ_RUST_LOG:-info}

      # Database
      DATABASE_URL: postgres://quiz_user:${QUIZ_DB_PASSWORD:-quiz_secret_dev}@postgres-quiz:5432/quiz_db

      # mTLS Configuration (SERVEUR - reçoit du gateway)
      MTLS_ENABLED: "true"
      MTLS_REQUIRE_CLIENT_CERT: "true"
      MTLS_SERVER_CERT: /etc/mtls/certs/server.crt
      MTLS_SERVER_KEY: /etc/mtls/certs/server.key
      MTLS_CLIENT_CA_CERT: /etc/mtls/certs/ca.crt

      # mTLS Configuration (CLIENT - appelle auth-service)
      MTLS_CLIENT_CERT: /etc/mtls/certs/client.crt
      MTLS_CLIENT_KEY: /etc/mtls/certs/client.key
      MTLS_SERVER_CA_CERT: /etc/mtls/certs/ca.crt

      # Service URLs
      AUTH_SERVICE_URL: https://auth-service:3001
    #      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
    #      ADS_SERVICE_URL: http://ads-service:3004

    volumes:
      # Montage certificats mTLS (SERVEUR + CLIENT)
      # Rôle SERVEUR (reçoit du gateway)
      - ./scripts/certs/generated/quiz-service-server.crt:/etc/mtls/certs/server.crt:ro
      - ./scripts/certs/generated/quiz-service-server.key:/etc/mtls/certs/server.key:ro
      # Rôle CLIENT (appelle auth-service)
      - ./scripts/certs/generated/quiz-service-client.crt:/etc/mtls/certs/client.crt:ro
      - ./scripts/certs/generated/quiz-service-client.key:/etc/mtls/certs/client.key:ro
      # CA (valide les deux côtés)
      - ./scripts/certs/generated/ca.crt:/etc/mtls/certs/ca.crt:ro
    expose:
      - "8080"
    depends_on:
      postgres-quiz:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: backend/api_gateway/Dockerfile
    container_name: api-gateway
    environment:
      # Service config
      PORT: 8000
      RUST_LOG: ${GATEWAY_RUST_LOG:-info}

      # mTLS Configuration (CLIENT uniquement - appelle les services backend)
      MTLS_ENABLED: "true"
      MTLS_CLIENT_CERT: /etc/mtls/certs/client.crt
      MTLS_CLIENT_KEY: /etc/mtls/certs/client.key
      MTLS_SERVER_CA_CERT: /etc/mtls/certs/ca.crt

      # Service URLs (HTTPS pour mTLS)
      AUTH_SERVICE_URL: https://auth-service:3001
      QUIZ_CORE_SERVICE_URL: https://quiz-core-service:8080
      #      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
      #      ADS_SERVICE_URL: http://ads-service:3004

      # Rate limiting
      RATE_LIMIT_REQUESTS_PER_MINUTE: ${RATE_LIMIT_RPM:-100}

    volumes:
      # Montage certificats mTLS (CLIENT uniquement)
      - ./scripts/certs/generated/gateway-client.crt:/etc/mtls/certs/client.crt:ro
      - ./scripts/certs/generated/gateway-client.key:/etc/mtls/certs/client.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/mtls/certs/ca.crt:ro
    ports:
      - "8000:8000"
    depends_on:
      auth-service:
        condition: service_healthy
      quiz-core-service:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  backend-network:
    driver: bridge
    name: quiz-backend-network

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres-auth-data:
    name: postgres-auth-data
  postgres-quiz-data:
    name: quiz-postgres-quiz-data
#  postgres-subscription-data:
#    name: quiz-postgres-subscription_service-data
#  postgres-ads-data:
#    name: quiz-postgres-ads_service-data
services:
  # ============================================
  # DATABASES (4 PostgreSQL instances)
  # ============================================

  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth_service
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-auth_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
      - ./docker/init-scripts/01-auth-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  #  postgres-subscription:
  #    image: postgres:16-alpine
  #    container_name: postgres-subscription_service
  #    environment:
  #      POSTGRES_DB: subscription_db
  #      POSTGRES_USER: subscription_user
  #      POSTGRES_PASSWORD: ${SUBSCRIPTION_DB_PASSWORD:-subscription_secret_dev}
  #      POSTGRES_INITDB_ARGS: "-E UTF8"
  #    ports:
  #      - "5433:5432"
  #    volumes:
  #      - postgres-subscription_service-data:/var/lib/postgresql/data
  #      - ./docker/init-scripts/02-subscription-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD-SHELL", "pg_isready -U subscription_user -d subscription_db"]
  #      interval: 10s
  #      timeout: 5s
  #      retries: 5
  #    restart: unless-stopped

  #  postgres-ads:
  #    image: postgres:16-alpine
  #    container_name: postgres-ads_service
  #    environment:
  #      POSTGRES_DB: ads_db
  #      POSTGRES_USER: ads_user
  #      POSTGRES_PASSWORD: ${ADS_DB_PASSWORD:-ads_secret_dev}
  #      POSTGRES_INITDB_ARGS: "-E UTF8"
  #    ports:
  #      - "5435:5432"
  #    volumes:
  #      - postgres-ads_service-data:/var/lib/postgresql/data
  #      - ./docker/init-scripts/04-ads-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD-SHELL", "pg_isready -U ads_user -d ads_db"]
  #      interval: 10s
  #      timeout: 5s
  #      retries: 5
  #    restart: unless-stopped

  postgres-quiz:
    image: postgres:16-alpine
    container_name: postgres-quiz
    environment:
      POSTGRES_DB: quiz_db
      POSTGRES_USER: quiz_user
      POSTGRES_PASSWORD: ${QUIZ_DB_PASSWORD:-quiz_secret_dev}
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5436:5432"
    volumes:
      - postgres-quiz-data:/var/lib/postgresql/data
      - ./docker/init-scripts/05-quiz-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quiz_user -d quiz_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # BACKEND SERVICES avec mTLS
  # ============================================

  auth-service:
      build:
        context: .
        dockerfile: backend/auth_service/Dockerfile
        args:
          SERVICE_NAME: auth_service
      container_name: auth_service-service
      environment:
        # Service config
        PORT: 3001
        RUST_LOG: info

        # Database
        DATABASE_URL: postgres://auth_user:${AUTH_DB_PASSWORD:-auth_secret_dev}@postgres-auth_service:5432/auth_db

        # mTLS Configuration (serveur)
        MTLS_ENABLED: "true"
        MTLS_CERT_PATH: "/etc/tls/tls.crt"
        MTLS_KEY_PATH: "/etc/tls/tls.key"
        MTLS_CA_PATH: "/etc/tls/ca.crt"
        MTLS_VERIFY_CLIENT: "true"
        MTLS_STRICT_MODE: "true"
        MTLS_ALLOWED_CNS: "gateway"

        # JWT
        JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret_change_in_production}
        JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev_refresh_secret_change_in_production}
        JWT_EXPIRATION_HOURS: 168
        JWT_REFRESH_EXPIRATION_HOURS: 720

        # OAuth
        GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
        GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
        APPLE_CLIENT_ID: ${APPLE_CLIENT_ID:-}
        APPLE_TEAM_ID: ${APPLE_TEAM_ID:-}

      volumes:
        - ./scripts/certs/generated/auth-service.crt:/etc/tls/tls.crt:ro
        - ./scripts/certs/generated/auth-service.key:/etc/tls/tls.key:ro
        - ./scripts/certs/generated/ca.crt:/etc/tls/ca.crt:ro
      ports:
        - "3001:3001"
      depends_on:
        postgres-auth:
          condition: service_healthy
      networks:
        - backend-network
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 40s
      restart: unless-stopped

  #  subscription-service:
  #    build:
  #      context: .
  #      dockerfile: docker/subscription.Dockerfile
  #      args:
  #        SERVICE_NAME: subscription_service
  #    container_name: subscription_service-service
  #    environment:
  #      PORT: 3002
  #      RUST_LOG: info
  #      DATABASE_URL: postgres://subscription_user:${SUBSCRIPTION_DB_PASSWORD:-subscription_secret_dev}@postgres-subscription_service:5432/subscription_db
  #      AUTH_SERVICE_URL: https://auth-service:3001
  #
  #      # Apple IAP
  #      APPLE_SHARED_SECRET: ${APPLE_SHARED_SECRET:-}
  #      APPLE_BUNDLE_ID: ${APPLE_BUNDLE_ID:-}
  #
  #      # Google IAP
  #      GOOGLE_SERVICE_ACCOUNT_JSON: ${GOOGLE_SERVICE_ACCOUNT_JSON:-}
  #
  #    ports:
  #      - "3002:3002"
  #    depends_on:
  #      postgres-subscription:
  #        condition: service_healthy
  #      auth-service:
  #        condition: service_healthy
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
  #      interval: 30s
  #      timeout: 10s
  #      retries: 3
  #      start_period: 40s
  #    restart: unless-stopped

  #  ads-service:
  #    build:
  #      context: .
  #      dockerfile: docker/ads.Dockerfile
  #      args:
  #        SERVICE_NAME: ads_service
  #    container_name: ads_service-service
  #    environment:
  #      PORT: 3004
  #      RUST_LOG: info
  #      DATABASE_URL: postgres://ads_user:${ADS_DB_PASSWORD:-ads_secret_dev}@postgres-ads_service:5432/ads_db
  #      AUTH_SERVICE_URL: https://auth-service:3001
  #      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
  #
  #      # AdMob
  #      ADMOB_APP_ID: ${ADMOB_APP_ID:-}
  #      ADMOB_PUBLISHER_ID: ${ADMOB_PUBLISHER_ID:-}
  #
  #    ports:
  #      - "3004:3004"
  #    depends_on:
  #      postgres-ads:
  #        condition: service_healthy
  #      auth-service:
  #        condition: service_healthy
  #    networks:
  #      - backend-network
  #    healthcheck:
  #      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
  #      interval: 30s
  #      timeout: 10s
  #      retries: 3
  #      start_period: 40s
  #    restart: unless-stopped

  quiz-core-service:
    build:
      context: .
      dockerfile: docker/backend_chef.Dockerfile
    container_name: quiz-core-service
    environment:
      # Service config
      PORT: 8080
      RUST_LOG: info

      # Database
      DATABASE_URL: postgres://quiz_user:${QUIZ_DB_PASSWORD:-quiz_secret_dev}@postgres-quiz:5432/quiz_db

      # mTLS Configuration (serveur)
      MTLS_ENABLED: "true"
      MTLS_CERT_PATH: "/etc/tls/tls.crt"
      MTLS_KEY_PATH: "/etc/tls/tls.key"
      MTLS_CA_PATH: "/etc/tls/ca.crt"
      MTLS_VERIFY_CLIENT: "true"
      MTLS_STRICT_MODE: "true"
      MTLS_ALLOWED_CNS: "gateway"

      # Service URLs (non utilises directement mais gardes pour compatibilite)
      AUTH_SERVICE_URL: https://auth-service:3001
#      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
#      ADS_SERVICE_URL: http://ads-service:3004

    volumes:
      # Monter les certificats mTLS
      - ./scripts/certs/generated/quiz-service.crt:/etc/tls/tls.crt:ro
      - ./scripts/certs/generated/quiz-service.key:/etc/tls/tls.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/tls/ca.crt:ro
    expose:
      - "8080"
    depends_on:
      postgres-quiz:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: backend/api_gateway/Dockerfile
    container_name: api-gateway
    environment:
      # Service config
      PORT: 8000
      RUST_LOG: info

      # mTLS Configuration (client side)
      MTLS_ENABLED: "true"
      MTLS_CERT_PATH: "/etc/tls/tls.crt"
      MTLS_KEY_PATH: "/etc/tls/tls.key"
      MTLS_CA_PATH: "/etc/tls/ca.crt"

      # Service URLs (HTTPS pour mTLS)
      AUTH_SERVICE_URL: https://auth-service:3001
      QUIZ_CORE_SERVICE_URL: https://quiz-core-service:8080
#      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
#      ADS_SERVICE_URL: http://ads-service:3004

      # Rate limiting
      RATE_LIMIT_REQUESTS_PER_MINUTE: 100

    volumes:
      # Monter les certificats mTLS
      - ./scripts/certs/generated/gateway.crt:/etc/tls/tls.crt:ro
      - ./scripts/certs/generated/gateway.key:/etc/tls/tls.key:ro
      - ./scripts/certs/generated/ca.crt:/etc/tls/ca.crt:ro
    ports:
      - "8000:8000"
    depends_on:
      quiz-core-service:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  backend-network:
    driver: bridge
    name: quiz-backend-network

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres-auth-data:
    name: postgres-auth-data
  postgres-quiz-data:
    name: quiz-postgres-quiz-data
#  postgres-subscription-data:
#    name: quiz-postgres-subscription_service-data
#  postgres-ads-data:
#    name: quiz-postgres-ads_service-data